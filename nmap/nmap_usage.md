Nmap Cheat Sheet
================

<details>
<summary><strong>üìå All in one Service Detection</strong></summary>

| Usage  | Description |
|----------|-------------|
| nmap -sV     | Service scan (Service/version info) |
| nmap -sV -F  | Service scan + The most common 100 ports |
| nmap -sV --top-ports 100 | Service scan + Top **100** ports) |
| nmap -sV -A  | Service scan + Aggresive mode (Essential Scripts) |
| nmap -sV 192.168.1.0/24  | Service scan + All Devices on Network |
| nmap -sV -p- | Service scan + **65535 possible** ports |
| nmap -sV -p 80,443,8080  | Service scan + Specific Port Discovery |
| nmap -sV -A  -p- | Service scan + Aggresive Mode (Essential Scripts) + **65535 possible** ports |
| nmap -sV -T4 | Service scan + Fast and Light scan) |
| nmap -sV -O | Service scan + **OS** Detection) |
| nmap -sV -sC | Service scan + **Default Scripts** |
| nmap -sV -sU | Service scan + **UDP Scan**) |
| nmap -sV -T3 -oN scan_results.txt  | Service scan + Timing + Output direction) |
| nmap -sV --traceroute | Service scan + Traceroute utility) |

</details>

<details>
<summary><strong>üìå Live Host Discovery</strong></summary>

<div align="center">
  <table>
    <tr>
      <td>
        <img src="/assets/osi.png" alt="Background" width="500" height="300">
      </td>
      <td>
        <img src="/assets/arp.png" alt="Background" width="500" height="300">
      </td>
    </tr>
  </table>
</div>


# üåê ARP        TCP/IP Link Layer üåê
---

## ARP Basics (-PR)
- ARP scan usually requires privileged user to access because ARP requests and responses involve low-level network operations. 
- sudo nmap -PR -sn IP_ADDRESS/24
- **"-PR"** means that only ARP scans will be performed.
- **-sn** discover online hosts without live-port scanning.
## Arp Scan Tool
---
- Installation: *apt install arp-scan*
- *arp-scan* provides customization of your scan.
-  *--localnet* or *-l* -> sends ARP queries to all valid IP addresses on your local network.
- *-I* parameter usage when there is more than one *interface*
## Examples:
---
- sudo arp-scan -l/--localnet IP_ADDRESS/24
- sudo arp-scan -I eth0/tun0 -l IP_ADDRESS/24
- sudo arp-scan IP_ADDRESS/24
- **same approach:** sudo nmap -PR -sn IP_ADDRESS/24

# üåê ICMP       OSI Network Layer (5) üåê
---
- You can ping every ip addresses on network using:
  - Echo **Request**: **ping (ICMP Type 8/Echo)**
  - Echo **Respond**: **ping (ICMP Type 0)**

- *ICMP echo request* discovery: **nmap -PE -sn MACHINE_IP/24** 
  - This scan will send *ICMP echo packets* to every IP_ADDRESS on the subnet. 
  - **Notice:** Many firewalls block *ICMP*
  - **We may not expect to find MAC addresses on the scan results.**

- Method is not always *trustworthy*
  - Many firewalls block ICMP echo; new versions of MS Windows are configured with a host firewall that blocks ICMP echo requests by default.
  - If you are on the same subnet with target, *ARP* will perform scan instead of ICMP.

<div align="center">
  <img src="/assets/ICMP1.png" alt="Background"/>
</div>

## How can we decrease the chance being blocked by firewalls ?

### ICMP Timestamp Usage **(-PP)**
---
- **ICMP Timestamp Request (Type 13)**
- **ICMP Timestamp Response (Type 14)**
- *nmap -PP -sn IP_ADDRESS/24* /24 will discover all the computers on the subnet.

#### General Information About ICMP Timestamp (Type 13/14)
---
- Used by a source host to request the current timestamp information from the destination host. 
- The source includes its own timestamp in the request packet.
- The destination host responds with an ICMP Timestamp Reply packet, which includes both the original timestamp from the request and the current timestamp from the destination host

<div align="center">
  <img src="/assets/ICMP2.png" alt="Background"/>
</div>

### ICMP Address Mask Usage **(-PM)**
---
- **ICMP Address Mask Request (Type 17)**
- **ICMP Address Mask Response (Type 18)**
- *nmap -PM -sn IP_ADDRESS/24* will attempt to discover live hosts using ICMP Address Masking.

#### General Information About ICMP Address Mask (Type 17/18)
---
- Used for requesting the +subnet mask+ information of the target host.
- The recipient should respond with the appropriate subnet mask for that IP address.
- ICMP Address Mask Request messages are relatively **less** commonly used compared to other **ICMP types**.

<div align="center">
  <img src="/assets/ICMP3.png" alt="Background"/>
</div>

---
## SUMMARY:
- ICMP Host discover involves 3 types of scanning approach
  - ICMP echo request (Type 8/Echo)
  - ICMP echo response (Type 0)
  - ICMP Timestamp request (Type 13)
  - ICMP Timestamp response (Type 14)
  - ICMP Address Mask request (Type 17)
  - ICMP Address Mask response (Type 18)

# üåê TCP        OSI Transport Layer (4) üåê

## What is **ping** ?
- Network utility used to test reachability of a host on an IP network.
- Ping is a staged operation.
  - 1) Pinging is an action which sends a small packet of data (ICMP Echo Request) to the target host IP_ADDRESS.
  - 2) The target host will respond if it is online on network. Otherwise packet will drop. 

## TCP SYN Ping (-PS)
- TCP SYN Ping, also known as a "SYN Ping" or "Half-open Ping," is a network diagnostic technique used to determine the reachability of a host on an IP network.
  - How it works ?
    - 1) Send a packet with the SYN (Synchronize) flag set to a TCP port, 80 by default, and wait for a response.
    - 2) An open port should reply with a SYN/ACK (Acknowledge); a closed port would result in an RST (Reset). 
    - 3) We only check whether we will get any response to infer whether the host is up.

- "-PS" parameter requires port specification !
  - Command: nmap -PS**80,443** -sn IP_ADDRESS 
  - Example: nmap -PS**88,135** -sn IP_ADDRESS
  - Entire machines on subnet: nmap -PS80,443 -sn IP_ADDRESS**/24**

<table>
  <tr>
    <td>
      <img src="/assets/ThreeWayHandshake.png" alt="3-Way-Handshake example 1">
    </td>
    <td>
      <img src="/assets/ThreeWayHandshake2.png" alt="3-Way-Handshake example 2">
    </td>
  </tr>
</table>

## TCP ACK Ping (-PA)
- This utility sends packets with an **ACK** flag
- **YOU MUST BE RUNNING NMAP AS A PRIVILEGED USER** to perform this scan.
  - If you try as a unprivileged user, nmap will attempt a **3-way handshake**
- By default port 80 is used, If you do not specify any port numbers.
### Example usage:
- Specific Port Number(s)
  - -PA21 or -PA23
  - -PA21,23,49,8080
- Port Range
  - -PA443-449 or -PA21-25

### The following figure shows that the target responds with the RST flag set because the TCP packet with the ACK flag is not part of any ongoing connection.
- The expected response is used to detect if the target host is up.
- The target host, not recognizing the ACK as part of an ongoing connection, responds with a packet that has the RST flag set. 

<div align="center">
  <img src="/assets/TCP-ACK.png" alt="Background"/>
</div>


# üåê UDP        OSI Transport Layer (4) üåê

## UDP Ping
- UDP (User Datagram Protocol) is a connectionless and lightweight transport protocol used in computer networking. 
- Making connection **faster** but **less reliable**, as it **does not guarantee** delivery or order of packets.
- Contrary to TCP SYN ping, sending a UDP packet to an open port is **not expected to lead to any reply**. 
### Command: nmap -PU -sn IP_ADDRESS/24 (For the entire subnet)

<table>
  <tr>
    <td>
      <img src="/assets/UDP1.png" alt="UDPEXAMPLE">
    </td>
    <td>
      <img src="/assets/UDP2.png" alt="UDPEXAMPLE2">
    </td>
  </tr>
</table>

## Masscan Tool
- Uses similar approach to discover live hosts.
- Provides **faster scan** process time compared to other techniques
- A bit aggressive method in terms of the rate of the packets it generate

### Installation
- **apt install masscan**

### Usage & Examples

  #### Subnet + Specific Port
  - masscan IP_ADDRESS/24 -p443
  #### Specific Port
  - masscan IP_ADDRESS -p80
  #### Specific Ports
  - masscan IP_ADDRESS -p8080,80,443
  #### Range
  - masscan IP_ADDRESS -p21-25
  #### Top Known 100 Ports
  - masscan IP_ADDRESS --top-ports 100

</details>

<summary><strong>üìå Basic Port Scans</strong></summary>

# Understanding Nmap Port States
<img src="./assets/nmapstate.png" alt="nmap state">


## Extra Information on parameters

<details>
<summary><strong>üìå "-A" Parameter </strong></summary>

- Known as **Aggresive Mode**
- Fast Scan using **-T4** 
- Auto OS detection **-O**
- Service Detection **-sV**
- Pingless Scanning **-Pn**
- Most common *100* ports **-F**
- Traceroute between host and target **--traceroute**
- NSE Scripting utility **-sC**

</details>

<details>
<summary><strong>üìå "-Pn" Parameter </strong></summary>

- Bypassing the noisy **ICMP probes** that could trigger alerts.
- You can better assess your **Network's defenses**
- Enabling you to gather information **without alerting the defenders.**
- You can verify whether your security measures are effectively **blocking unauthorized access** attemps
- **Ethical Consideration**: Using -Pn without proper authorization can be seen as an aggressive action and might lead to unintended consequences.

</details>

<details>
<summary><strong>üìå Bypassing Firewall </strong></summary>

### TCP FIN, NULL, and Xmas Scans

These three scan types, exploit a subtle loophole in the TCP RFC(793) to differentiate between open and closed ports.
The key advantage to these scan types is that they can sneak through certain non-stateful firewalls and packet filtering routers.
Another advantage is that these scan types are a little more stealthy than even a SYN scan

### Null scan (-sN)

- Does not set any bits (TCP flag header is 0).

### FIN scan (-sF)

- Sets just the TCP FIN bit.

### Xmas scan (-sX)

- Sets the FIN, PSH, and URG flags, lighting the packet up like a Christmas tree.

| Probe Response | Assigned State |
|----------|-------------|
| No response received (even after retransmissions) | open|filtered |
| TCP RST packet | closed |
| ICMP unreachable error (type 3, code 1, 2, 3, 9, 10, or 13) | filtered|

</details>

