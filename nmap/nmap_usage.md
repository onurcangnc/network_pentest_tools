Nmap Cheat Sheet
================

<details>
<summary><strong>üìå All in one Service Detection</strong></summary>

| Usage  | Description |
|----------|-------------|
| nmap -sV     | Service scan (Service/version info) |
| nmap -sV -F  | Service scan + The most common 100 ports |
| nmap -sV --top-ports 100 | Service scan + Top **100** ports) |
| nmap -sV -A  | Service scan + Aggresive mode (Essential Scripts) |
| nmap -sV 192.168.1.0/24  | Service scan + All Devices on Network |
| nmap -sV -p- | Service scan + **65535 possible** ports |
| nmap -sV -p 80,443,8080  | Service scan + Specific Port Discovery |
| nmap -sV -A  -p- | Service scan + Aggresive Mode (Essential Scripts) + **65535 possible** ports |
| nmap -sV -T4 | Service scan + Fast and Light scan) |
| nmap -sV -O | Service scan + **OS** Detection) |
| nmap -sV -sC | Service scan + **Default Scripts** |
| nmap -sV -sU | Service scan + **UDP Scan**) |
| nmap -sV -T3 -oN scan_results.txt  | Service scan + Timing + Output direction) |
| nmap -sV --traceroute | Service scan + Traceroute utility) |

</details>

<details>
<summary><strong>üìå Live Host Discovery</strong></summary>

<div align="center">
  <table>
    <tr>
      <td>
        <img src="/assets/osi.png" alt="Background" width="500" height="300">
      </td>
      <td>
        <img src="/assets/arp.png" alt="Background" width="500" height="300">
      </td>
    </tr>
  </table>
</div>


# üåê ARP        TCP/IP Link Layer üåê
---

## ARP Basics (-PR)
- ARP scan usually requires privileged user to access because ARP requests and responses involve low-level network operations. 
- sudo nmap -PR -sn IP_ADDRESS/24
- **"-PR"** means that only ARP scans will be performed.
- **-sn** discover online hosts without live-port scanning.
## Arp Scan Tool
---
- Installation: *apt install arp-scan*
- *arp-scan* provides customization of your scan.
-  *--localnet* or *-l* -> sends ARP queries to all valid IP addresses on your local network.
- *-I* parameter usage when there is more than one *interface*
## Examples:
---
- sudo arp-scan -l/--localnet IP_ADDRESS/24
- sudo arp-scan -I eth0/tun0 -l IP_ADDRESS/24
- sudo arp-scan IP_ADDRESS/24
- **same approach:** sudo nmap -PR -sn IP_ADDRESS/24

# üåê ICMP       OSI Network Layer (5) üåê
---
- You can ping every ip addresses on network using:
  - Echo **Request**: **ping (ICMP Type 8/Echo)**
  - Echo **Respond**: **ping (ICMP Type 0)**

- *ICMP echo request* discovery: **nmap -PE -sn MACHINE_IP/24** 
  - This scan will send *ICMP echo packets* to every IP_ADDRESS on the subnet. 
  - **Notice:** Many firewalls block *ICMP*
  - **We may not expect to find MAC addresses on the scan results.**

- Method is not always *trustworthy*
  - Many firewalls block ICMP echo; new versions of MS Windows are configured with a host firewall that blocks ICMP echo requests by default.
  - If you are on the same subnet with target, *ARP* will perform scan instead of ICMP.

<div align="center">
  <img src="/assets/ICMP1.png" alt="Background"/>
</div>

## How can we decrease the chance being blocked by firewalls ?

### ICMP Timestamp Usage **(-PP)**
---
- **ICMP Timestamp Request (Type 13)**
- **ICMP Timestamp Response (Type 14)**
- *nmap -PP -sn IP_ADDRESS/24* /24 will discover all the computers on the subnet.

#### General Information About ICMP Timestamp (Type 13/14)
---
- Used by a source host to request the current timestamp information from the destination host. 
- The source includes its own timestamp in the request packet.
- The destination host responds with an ICMP Timestamp Reply packet, which includes both the original timestamp from the request and the current timestamp from the destination host

<div align="center">
  <img src="/assets/ICMP2.png" alt="Background"/>
</div>

### ICMP Address Mask Usage **(-PM)**
---
- **ICMP Address Mask Request (Type 17)**
- **ICMP Address Mask Response (Type 18)**
- *nmap -PM -sn IP_ADDRESS/24* will attempt to discover live hosts using ICMP Address Masking.

#### General Information About ICMP Address Mask (Type 17/18)
---
- Used for requesting the +subnet mask+ information of the target host.
- The recipient should respond with the appropriate subnet mask for that IP address.
- ICMP Address Mask Request messages are relatively **less** commonly used compared to other **ICMP types**.

<div align="center">
  <img src="/assets/ICMP3.png" alt="Background"/>
</div>

---
## SUMMARY:
- ICMP Host discover involves 3 types of scanning approach
  - ICMP echo request (Type 8/Echo)
  - ICMP echo response (Type 0)
  - ICMP Timestamp request (Type 13)
  - ICMP Timestamp response (Type 14)
  - ICMP Address Mask request (Type 17)
  - ICMP Address Mask response (Type 18)

# üåê TCP        OSI Transport Layer (4) üåê

## What is **ping** ?
- Network utility used to test reachability of a host on an IP network.
- Ping is a staged operation.
  - 1) Pinging is an action which sends a small packet of data (ICMP Echo Request) to the target host IP_ADDRESS.
  - 2) The target host will respond if it is online on network. Otherwise packet will drop. 

## TCP SYN Ping (-PS)
- TCP SYN Ping, also known as a "SYN Ping" or "Half-open Ping," is a network diagnostic technique used to determine the reachability of a host on an IP network.
  - How it works ?
    - 1) Send a packet with the SYN (Synchronize) flag set to a TCP port, 80 by default, and wait for a response.
    - 2) An open port should reply with a SYN/ACK (Acknowledge); a closed port would result in an RST (Reset). 
    - 3) We only check whether we will get any response to infer whether the host is up.

- "-PS" parameter requires port specification !
  - Command: nmap -PS**80,443** -sn IP_ADDRESS 
  - Example: nmap -PS**88,135** -sn IP_ADDRESS
  - Entire machines on subnet: nmap -PS80,443 -sn IP_ADDRESS**/24**

<table>
  <tr>
    <td>
      <img src="/assets/ThreeWayHandshake.png" alt="3-Way-Handshake example 1">
    </td>
    <td>
      <img src="/assets/ThreeWayHandshake2.png" alt="3-Way-Handshake example 2">
    </td>
  </tr>
</table>

## TCP ACK Ping (-PA)
- This utility sends packets with an **ACK** flag
- **YOU MUST BE RUNNING NMAP AS A PRIVILEGED USER** to perform this scan.
  - If you try as a unprivileged user, nmap will attempt a **3-way handshake**
- By default port 80 is used, If you do not specify any port numbers.
### Example usage:
- Specific Port Number(s)
  - -PA21 or -PA23
  - -PA21,23,49,8080
- Port Range
  - -PA443-449 or -PA21-25

### The following figure shows that the target responds with the RST flag set because the TCP packet with the ACK flag is not part of any ongoing connection.
- The expected response is used to detect if the target host is up.
- The target host, not recognizing the ACK as part of an ongoing connection, responds with a packet that has the RST flag set. 

<div align="center">
  <img src="/assets/TCP-ACK.png" alt="Background"/>
</div>


# üåê UDP        OSI Transport Layer (4) üåê

## UDP Ping
- UDP (User Datagram Protocol) is a connectionless and lightweight transport protocol used in computer networking. 
- Making connection **faster** but **less reliable**, as it **does not guarantee** delivery or order of packets.
- Contrary to TCP SYN ping, sending a UDP packet to an open port is **not expected to lead to any reply**. 
### Command: nmap -PU -sn IP_ADDRESS/24 (For the entire subnet)

<table>
  <tr>
    <td>
      <img src="/assets/UDP1.png" alt="UDPEXAMPLE">
    </td>
    <td>
      <img src="/assets/UDP2.png" alt="UDPEXAMPLE2">
    </td>
  </tr>
</table>

## Masscan Tool
- Uses similar approach to discover live hosts.
- Provides **faster scan** process time compared to other techniques
- A bit aggressive method in terms of the rate of the packets it generate

### Installation
- **apt install masscan**

### Usage & Examples

  #### Subnet + Specific Port
  - masscan IP_ADDRESS/24 -p443
  #### Specific Port
  - masscan IP_ADDRESS -p80
  #### Specific Ports
  - masscan IP_ADDRESS -p8080,80,443
  #### Range
  - masscan IP_ADDRESS -p21-25
  #### Top Known 100 Ports
  - masscan IP_ADDRESS --top-ports 100

</details>

<details>
<summary><strong>üìå Basic Port Scans</strong></summary>

<details>
<summary>**TCP Connect Scan**</summary>

- A TCP connect scan, also known as a "**full connect scan**" is a type of port scanning technique used to determine the status of ports on a target host.

- It's one of the most straightforward and generally used methods for discovering open and closed ports on a remote system. 

- Warning: TCP connect scan is a part of network reconnaissance (discovery) approach and can be utilized for both **legitimate network administration purposes and potentially malicious activities**.

## How a TCP Connect Scan work ?
1.**TCP Ports**
  - Each service or application that runs on a computer typically listens on specific TCP ports. Ports are numbered from 0 to 65535.
2.**Three-way Handshake**
  - The scanning computer (initiator) sends a **TCP SYN** (synchronize) packet to the target port.
  - If the target port is open and listening, it responds with a **TCP SYN-ACK** (synchronize-acknowledge) packet.
  - The scanning computer sends a final TCP ACK (acknowledge) packet to complete the handshake.
3.**Response Analysis**
  - If the scanning computer receives a **SYN-ACK packet**, the port is considered open.
  - If the scanning computer receives an **RST (reset) packet**, the port is considered closed.
4.**Stealthiness**
  - One of the advantages of a TCP connect scan is that it's more difficult to detect compared to other types of scans like SYN scans or NULL scans.
  - A **full three-way handshake** is completed, making it look more *like a legitimate connection* attempt rather than a probe.

## Disadvantages
- It's **slower** than some other scanning techniques since it requires the complete **three-way handshake**.
- It can potentially **leave traces** in the target **system's logs**, especially if done in a careless or aggressive manner.

<table>
  <tr>
    <td>
      <img src="/assets/tcpconnect1.png" alt="tcpconnect1">
    </td>
    <td>
      <img src="/assets/tcpconnect2.png" alt="tcpconnect2">
    </td>
  </tr>
</table>

- **Warning:** If you are not a **privileged user** (root or sudoer), a TCP connect scan is the **only possible option to discover open TCP ports**.
- Syntax: nmap -sT IP_ADDRESS

### Example Run

<img src="/assets/exampleTCPConnect.png">

</details>

<details>
<summary>**TCP SYN Scan**</summary>

- A TCP SYN scan, also known as a "half-open scan" or "stealth scan," is another popular technique used in network port scanning

- The default scan mode is SYN scan, and it requires a privileged (root or sudoer) user to run it.

- SYN scan does not need to complete the TCP 3-way handshake; instead, it tears down the connection once it receives a response from the server.

- We can use this scan type by using "**-sS**" parameter.

- nmap -sS IP_ADDRESS

<div align="center">
  <img src="/assets/tcpsyn1.png" alt="tcpsyn"/>
</div>

### Example Run

<img src="/assets/exampleTCPSYN.png" alt="tcpsyn"/>

</details>

<details>
<summary>**UDP Scan**</summary>

- UDP scanning is a method used to identify open UDP ports on a target system or network.

- UDP is connectionless, and there is no formal acknowledgement of packets received.

- **Warning:** UDP scan type cannot guarantee that a service listening on a UDP port would respond to our packets.

- If a UDP packet is sent to a closed port, an **ICMP port unreachable error (type 3, code 3) is returned**.

- Syntax: nmap **-sU** IP_ADDRESS

<table>
  <tr>
    <td>
      <img src="/assets/udpscan2.png" alt="tcpconnect1">
      The UDP ports that don‚Äôt generate any response are the ones that Nmap will state as open.
    </td>
    <td>
      <img src="/assets/udpscan1.png" alt="tcpconnect2">
      Scan status: port is closed since we get **ICMP packet of type 3, destination unreachable, and code 3, port unreachable.**
    </td>
  </tr>
</table>

<img src="/assets/exampleUDP.png" alt="udpscan"/>
</details>

<details>
<summary>**Scaling & Scope & Performance**<summary>
- We can give nmap specific parameters to identify our scope, performance and scale.

# Specifying Ports

- Port List: **-p22,23,443**
- Port Range: **-p21-1020** will scan 21 to 1020
- Full Ports: **-p-**
- Most common 100 ports: **-F** // --top-ports 100

# Scan Time Control
- You can use **-T < 0-5 >** option to determine the speed of the scan operation.
  - paranoid (0) Avoid IDS
  - sneaky (1) Avoid IDS & Real Operations
  - polite (2)
  - normal (3) default nmap setting
  - aggressive (4) Recommended for the CTFs
  - insane (5)

</details>
</details>


## Extra Information on parameters

<details>
<summary><strong>üìå "-A" Parameter </strong></summary>

- Known as **Aggresive Mode**
- Fast Scan using **-T4** 
- Auto OS detection **-O**
- Service Detection **-sV**
- Pingless Scanning **-Pn**
- Most common *100* ports **-F**
- Traceroute between host and target **--traceroute**
- NSE Scripting utility **-sC**

</details>

<details>
<summary><strong>üìå "-Pn" Parameter </strong></summary>

- Bypassing the noisy **ICMP probes** that could trigger alerts.
- You can better assess your **Network's defenses**
- Enabling you to gather information **without alerting the defenders.**
- You can verify whether your security measures are effectively **blocking unauthorized access** attemps
- **Ethical Consideration**: Using -Pn without proper authorization can be seen as an aggressive action and might lead to unintended consequences.

</details>

<details>
<summary><strong>üìå Bypassing Firewall </strong></summary>

### TCP FIN, NULL, and Xmas Scans

These three scan types, exploit a subtle loophole in the TCP RFC(793) to differentiate between open and closed ports.
The key advantage to these scan types is that they can sneak through certain non-stateful firewalls and packet filtering routers.
Another advantage is that these scan types are a little more stealthy than even a SYN scan

### Null scan (-sN)

- Does not set any bits (TCP flag header is 0).

### FIN scan (-sF)

- Sets just the TCP FIN bit.

### Xmas scan (-sX)

- Sets the FIN, PSH, and URG flags, lighting the packet up like a Christmas tree.

| Probe Response | Assigned State |
|----------|-------------|
| No response received (even after retransmissions) | open|filtered |
| TCP RST packet | closed |
| ICMP unreachable error (type 3, code 1, 2, 3, 9, 10, or 13) | filtered|

</details>

<details>
<summary><strong>üìå TCP/UDP Ports</strong></summary>

# **Understanding Nmap Port States**
<img src="/assets/nmapstate.png" alt="nmap state">

| State       | Description                                                                                                     |
|-------------------|-----------------------------------------------------------------------------------------------------------------|
|  ‚úÖ Open              | Indicates that a service is listening on the specified port.                                                 |
| :x: Closed            | Indicates that no service is listening on the specified port, although the port is accessible.               |
| :fire: üõ°Ô∏è Filtered          | Nmap cannot determine if the port is open or closed due to inaccessibility, often caused by a firewall.    |
| :signal_strength: Unfiltered        | Nmap cannot determine if the port is open or closed, but it's accessible (observed in ACK scan *-sA*).       |
| :question: Open|Filtered     | Nmap cannot determine if the port is open or filtered.                                                     |
| :grey_question: Closed|Filtered   | Nmap cannot determine if the port is closed or filtered.                                                   |

# **Port Categorization**

<p>Ports are categorized based on the transport protocol they use, primarily **TCP (Transmission Control Protocol)** or **UDP (User Datagram Protocol)**. 
These protocols are used to transmit data over networks, and the choice of protocol often depends on the specific requirements of the application or service.
</p>

## TCP Ports
<p>TCP is connection oriented protocol which **ensures reliable data delivery** between *client* & *receiver*.
Moreover, TCP ports are used for applications that need **stable & ordered data** transfer.
</p>

### Examples
* Text Communication
  - Instagram
  - Whatsapp
  - Google Chat
  - iMessage
* Transfer of files | FTP
  - FileZilla Client and Server
  - **Control Connection**: FTP sends information like user identification and passwords.
  - **Data Connection**: In this connection, files are sent over the network.
* HyperText Transfer Protocol (HTTP)
  - TCP is used to access data on the**World Wide Web**
  - Acessing the web pages present on WWW are more stable since TCP provides inorder data, error control and flow control.
* Simple Mail Transfer Protocol(SMTP)
  - Yahoo, Outlook, Gmail and so on.
  - SMTP is a **Application Layer** protocol used to send Emails from one system to another.
  - SMTP uses TCP to communicate with *SMTP Server*.
  - When *SMTP Server* accepts the connection request, it allows sender to send mail.

## UDP Ports
<p>UDP is a connectionless protocol which provides **fast data transfer** but does **not guarantee data delivery** or **order**.</p> 
- UDP ports are used when **speed and efficiency** are more critical than **reliability**.

### Examples
* Streaming media
  - Video conferencing
  - Watching Netflix, Youtube, Disney+ and so on.
  - Streaming on Twitch.
* Online gaming
* VoIP (Voice over IP)
* DNS (Domain Name System)
  + UDP is much faster than TCP. After all, speed matters a lot when loading a webpage 
  + DNS requests are typically small requests and can be accommodated inside UDP segments (Header).
  + Even though UDP is unreliable, it can be achieved in the application layer too.

<details>
<summary><strong> üìå Well-Known ports list</strong></summary>

| Port Number | Protocol | Service/Application           |
|-------------|----------|-------------------------------|
| 20          | TCP/UDP  | FTP Data Transfer            |
| 21          | TCP      | FTP Control (Command)        |
| 22          | TCP      | SSH (Secure Shell)           |
| 23          | TCP      | Telnet                        |
| 25          | TCP      | SMTP (Simple Mail Transfer)  |
| 53          | TCP/UDP  | DNS (Domain Name System)     |
| 67          | UDP      | DHCP Server                  |
| 68          | UDP      | DHCP Client                  |
| 80          | TCP      | HTTP (Hypertext Transfer)    |
| 110         | TCP      | POP3 (Post Office Protocol)  |
| 143         | TCP      | IMAP (Internet Message Access Protocol) |
| 443         | TCP      | HTTPS (HTTP Secure)          |
| 587         | TCP      | SMTP Submission              |
| 993         | TCP      | IMAPS (IMAP Secure)          |
| 995         | TCP      | POP3S (POP3 Secure)          |
</details>

## TCP Flags
TCP flags known as *TCP Control Flags* are fundamental components of the *TCP Header* used to manage and control various aspects of the TCP communication process.

![TCP Flags](/assets/TCPFLAGS.png)

### TCP Flags Lists & Description

#### URG (Urgent)
**Description:** Indicates that the Urgent pointer field is significant. It points to urgent data that should be prioritized. Used in conjunction with the URG flag in the TCP header.

#### ACK (Acknowledgment)
**Description:** Indicates that the acknowledgment field is significant. It confirms the receipt of data and acknowledges the successful processing of a segment. Used in conjunction with the ACK flag in the TCP header.

#### PSH (Push)
**Description:** Push flag asking TCP to promptly pass the data to the application. It triggers the immediate delivery of accumulated data to the receiving application.

#### RST (Reset)
**Description:** Reset flag is used to forcefully terminate a connection. It can be sent by devices like firewalls to tear down a TCP connection. The RST flag is also used when sending data to a host with no active service to respond.

#### SYN (Synchronize)
**Description:** Synchronize flag is used to initiate a TCP 3-way handshake and synchronize sequence numbers between hosts. During connection establishment, the sequence number should be set randomly to enhance security.

#### FIN (Finish)
**Description:** The sender uses the FIN flag to signal the completion of data transmission. It indicates that the sender has no more data to send.

</details>

